<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ami.ec.channel.dao.pluginManager.ExecTaskMapper" >
  <resultMap id="BaseResultMap" type="com.ami.ec.channel.domain.pluginManager.ExecTask" >
    <id column="IF_id" property="ifId" jdbcType="BIGINT" />
    <result column="IF_code" property="ifCode" jdbcType="NVARCHAR" />
    <result column="IF_name" property="ifName" jdbcType="NVARCHAR" />
    <result column="IF_cat" property="ifCat" jdbcType="NVARCHAR" />
    <result column="Error_retry_times" property="errorRetryTimes" jdbcType="INTEGER" />
    <result column="Retry_wait_seconds" property="retryWaitSeconds" jdbcType="INTEGER" />
    <result column="Pj_id" property="pjId" jdbcType="BIGINT" />
    <result column="Store_id" property="storeId" jdbcType="BIGINT" />
    <result column="Bat_no_pre" property="batNoPre" jdbcType="VARCHAR" />
    <result column="Bat_no_length" property="batNoLength" jdbcType="INTEGER" />
    <result column="Bat_no_current" property="batNoCurrent" jdbcType="INTEGER" />
    <result column="ifStatus" property="ifStatus" jdbcType="INTEGER" />    
    <result column="IF_time_1" property="ifTime1" jdbcType="TIMESTAMP" />
    <result column="IF_time_2" property="ifTime2" jdbcType="TIMESTAMP" />
    <result column="IF_time_3" property="ifTime3" jdbcType="TIMESTAMP" />
    
    <result column="IF_line_id" jdbcType="INTEGER" property="ifLineId" />
    <result column="Last_time" jdbcType="TIMESTAMP" property="lastTime" />
    <result column="Type_info" jdbcType="NVARCHAR" property="typeInfo" />
    <result column="Call_method" jdbcType="VARCHAR" property="callMethod" />
    <result column="Method_parameters" jdbcType="VARCHAR" property="methodParameters" />
    <result column="Ftp_url" jdbcType="VARCHAR" property="ftpUrl" />
    <result column="Ftp_path" jdbcType="VARCHAR" property="ftpPath" />
    <result column="Ftp_uid" jdbcType="VARCHAR" property="ftpUid" />
    <result column="Ftp_pwd" jdbcType="VARCHAR" property="ftpPwd" />
    <result column="Ftp_port" jdbcType="INTEGER" property="ftpPort" />
    <result column="File_encoding" jdbcType="VARCHAR" property="fileEncoding" />
    
    <result column="Task_id" property="taskId" jdbcType="INTEGER" />
    <result column="First_start_dateTime" property="taskStartTime" jdbcType="TIMESTAMP" />
    <result column="End_dateTime" property="taskEndTime" jdbcType="TIMESTAMP" />
    <result column="Lastest_start_dateTime" property="lastestStartDatetime" jdbcType="TIMESTAMP" />
    <result column="Is_last_success" property="isLastSuccess" jdbcType="BIT" />
    <result column="taskStatus" property="taskStatus" jdbcType="INTEGER" />
    
    <result column="Task_queue_id" property="taskQueueId" jdbcType="BIGINT" />
    <result column="Start_time" property="startTime" jdbcType="TIMESTAMP" />
    <result column="End_time" property="endTime" jdbcType="TIMESTAMP" />
    <result column="Is_dealed" property="isDealed" jdbcType="BIT" />
    <result column="Dealed_time" property="dealedTime" jdbcType="TIMESTAMP" />
    <result column="Is_right_now" property="isRightNow" jdbcType="BIT" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    i.IF_id,i.IF_code,i.IF_name,i.IF_cat,i.Error_retry_times,i.Retry_wait_seconds,i.Pj_id,i.Store_id,i.Bat_no_pre,i.Bat_no_length,i.Bat_no_current,i.status ifStatus,i.IF_time_1,i.IF_time_2,i.IF_time_3,
    il.IF_line_id,il.Last_time,il.Type_info,il.Call_method,il.Method_parameters,il.Ftp_url,il.Ftp_path,il.Ftp_uid,il.Ftp_pwd,il.Ftp_port,il.File_encoding,
    td.Task_id,td.First_start_dateTime,td.End_dateTime,td.Lastest_start_dateTime,td.Is_last_success,td.status taskStatus,
    tq.Task_queue_id, tq.Start_time, tq.End_time, tq.Is_dealed, tq.Dealed_time, tq.Is_right_now
  </sql>
  <select id="selectTaskQueue" resultMap="BaseResultMap" parameterType="java.util.Map" >
    select
    <if test="distinct" >
      distinct
    </if>
    <include refid="Base_Column_List" />
    from IF_define i 
    left join IF_define_line il on i.IF_id = il.IF_id 
    left join Task_define td on i.IF_id = td.IF_id 
    inner join Task_queue tq on td.Task_id = tq.Task_id
    where i.IF_cat = 'Official' and (tq.Is_dealed = 0 or tq.Is_dealed is null) 
<!--    and i.status = 1 and td.status = 1 -->
    and (tq.status != -1 or tq.status is null)
    <if test="PjId != null" >
      and i.Pj_id = ${PjId}
    </if>
     <if test="StoreId != null" >
      and i.Store_id = ${StoreId}
    </if>    
     <if test="TaskQueueId != null" >
      and tq.Task_queue_id > ${TaskQueueId}
    </if>
    order by tq.Task_queue_id
  </select>
  <update id="updateIfDefineBatNoCurrent" parameterType="java.util.Map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    update IF_define
    set Bat_no_current = #{batNoCurrent,jdbcType=INTEGER}
    where IF_id = #{ifId,jdbcType=INTEGER}
  </update>
</mapper>